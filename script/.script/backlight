#!/bin/bash

STEP=5 # Step Up/Down brightnes by: 5 = ".05", 10 = ".10", etc.
QUIET="false" #TODO

current_brightness() {
    xrandr --verbose --current | grep ^"$SCREEN" -A5 | tail -n1
}

if [ "$#" -eq  "0" ]; then
    current_brightness | cut -d':' -f 2 | xargs
    exit 0
fi

usage() {
    echo -e "Usage: backlight [options]\n" \
        "Options:\n" \
            "       Get current brightness\n" \
            "  +    Increase brightness\n" \
            "  -    Decrease brightness"
}

while true; do
    case "$1" in
        --quiet) QUIET="true"; shift ;;
        --help) usage; exit 0 ;;
        #up|down) shift; continue ;;
        #+|-) shift; continue ;;
        *) break;;
    esac
done

cbright=$(current_brightness)
cbright="${cbright##* }" # Get brightness level with decimal place

vleft=${cbright%%"."*} # Extract left of decimal point
vright=${cbright#*"."} # Extract right of decimal point

mbright="0"
[[ "$vleft" != 0 && "$STEP" -lt 10 ]] && STEP=10    # > 1.0, only .1 works
[[ "$vleft" != 0 ]] && mbright="$vleft"00           # 1.0 becomes "100"
[[ "${#vright}" -eq 1 ]] && vright="$vright"0       # 0.5 becomes "50"
mbright=$(( mbright + vright ))

[[ "$1" == "up" || "$1" == "+" ]] && mbright=$(( mbright + STEP ))
[[ "$1" == "down" || "$1" == "-" ]] && mbright=$(( mbright - STEP ))
[[ "${mbright:0:1}" == "-" ]] && mbright=0    # Negative not allowed
[[ "$mbright" -gt 999  ]] && mbright=999      # Can't go over 9.99

if [[ "${#mbright}" -eq 3 ]] ; then
    mbright="$mbright"000 # Pad with lots of zeros
    cbright="${mbright:0:1}.${mbright:1:2}"
else
    mbright="$mbright"000 # Pad with lots of zeros
    cbright=".${mbright:0:2}"
fi

xrandr --output "$SCREEN" --brightness "$cbright" # Set new brightness
if [[ $QUIET != "true" ]]; then
    current_brightness | cut -d':' -f 2 | xargs
fi
